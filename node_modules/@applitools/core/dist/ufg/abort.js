"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.makeAbort = void 0;
const abort_error_1 = require("../errors/abort-error");
const driver_1 = require("@applitools/driver");
function makeAbort({ storage, target, spec, controller, logger: defaultLogger, }) {
    return async function ({ settings, logger = defaultLogger, } = {}) {
        controller.abort();
        const tests = storage.reduce((tests, { renderer, promise }) => {
            const key = JSON.stringify(renderer);
            return tests.set(key, promise);
        }, new Map());
        return Promise.all(Array.from(tests.values(), async (promise) => {
            let eyes, renderer;
            try {
                const value = await promise;
                eyes = value.eyes;
                renderer = value.renderer;
            }
            catch (error) {
                eyes = error.info.eyes;
                renderer = error.info.renderer;
                if (!eyes) {
                    if (error instanceof abort_error_1.AbortError)
                        return error.info;
                    else
                        throw error;
                }
            }
            const driver = (0, driver_1.isDriver)(target, spec) ? await (0, driver_1.makeDriver)({ spec, driver: target, logger }) : null;
            const testMetadata = await (driver === null || driver === void 0 ? void 0 : driver.getSessionMetadata());
            const [result] = await eyes.abort({ settings: { ...settings, testMetadata }, logger });
            return { ...result, renderer };
        }));
    };
}
exports.makeAbort = makeAbort;
