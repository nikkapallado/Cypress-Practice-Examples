"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.makeClose = void 0;
const driver_1 = require("@applitools/driver");
function makeClose({ storage, target, spec, logger: defaultLogger, }) {
    return async function ({ settings, logger = defaultLogger, } = {}) {
        const tests = storage.reduce((tests, { renderer, promise }) => {
            var _a;
            const key = JSON.stringify(renderer);
            const promises = (_a = tests.get(key)) !== null && _a !== void 0 ? _a : [];
            promises.push(promise);
            return tests.set(key, promises);
        }, new Map());
        return Promise.all(Array.from(tests.values(), async (promises) => {
            var _a, _b;
            try {
                const [{ eyes, renderer }] = await Promise.all(promises);
                const driver = (0, driver_1.isDriver)(target, spec) ? await (0, driver_1.makeDriver)({ spec, driver: target, logger }) : null;
                const testMetadata = await (driver === null || driver === void 0 ? void 0 : driver.getSessionMetadata());
                const [result] = await eyes.close({ settings: { ...settings, testMetadata }, logger });
                return { ...result, renderer };
            }
            catch (error) {
                await ((_b = (_a = error.info) === null || _a === void 0 ? void 0 : _a.eyes) === null || _b === void 0 ? void 0 : _b.abort({ logger }));
                throw error;
            }
        }));
    };
}
exports.makeClose = makeClose;
